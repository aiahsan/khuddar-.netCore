@model KhuddarVsModals.Models.KhuddarEarnToPLayVideo

@{
    ViewData["Title"] = "Videos";
}
@await Html.PartialAsync("_toastLayout")


@await Html.PartialAsync("_titleBreadView", new string[] { "Earn to Play", "Home", "" })


@Html.AntiForgeryToken()
<div class="row">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                Earn To Play
            </div>
            <div class="card-body">
                <form asp-action="category" id="formMain">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="form-group" style="display:none">
                        <label asp-for="Id" class="control-label"></label>
                        <input asp-for="Id" class="form-control" />
                        <span asp-validation-for="Id" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="videoId" class="control-label"></label>
                        <input asp-for="videoId" class="form-control" />
                        <span asp-validation-for="videoId" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="source" class="control-label"></label>
                        <select asp-items="@(new SelectList(ViewBag.sourse))" asp-for="source" class="form-control"></select>
                        <span asp-validation-for="source" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="title" class="control-label"></label>
                        <input asp-for="title" class="form-control" />
                        <span asp-validation-for="title" class="text-danger"></span>
                    </div> <div class="form-group">
                        <label asp-for="thumbnail" class="control-label"></label>
                        <input asp-for="thumbnail" class="form-control" />
                        <span asp-validation-for="thumbnail" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="expiryDate" class="control-label"></label>
                        <input asp-for="expiryDate" class="form-control" />
                        <span asp-validation-for="expiryDate" class="text-danger"></span>
                    </div>

                    <div class="form-group form-check">
                        <label class="form-check-label">
                            <input onclick="setStatusVal()" class="form-check-input" asp-for="status" checked /> @Html.DisplayNameFor(model => model.status)
                        </label>
                    </div>

                    <div class="form-group">
                        <input id="btnadd" type="button" value="Add" class="btn btn-primary" />
                    </div>
                </form>

            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header">Categories</div>
            <div class="card-body">
                <div class="table-responsive" style="max-height:300px">
                    <table class="table table-striped" id="tableCategories">
                        <thead>
                            <tr>
                                <th>Video Link</th>
                                <th>Source</th>
                                <th>Title</th>
                                <th>Thumbnail Link</th>
                                <th>Expiry Date</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>

                    </table>
                </div>
                <div>
                    <button id="btnSubmit" class="btn btn-primary">Submit</button>
                </div>
            </div>

        </div>
    </div>
</div>
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>

<script>
    //0:add 1:edit
    var mode = 0;
    var editNode;
    function deletenode(val) {
        $(val.parentNode.parentNode.parentNode).remove();

    }
    function setStatusVal() {
        let valStatus = $("#status").val();
        if (valStatus == "true") {
            $("#status").val(false);
        }
        else {
            $("#status").val(true);
        }
    }
    function getStatus() {
        if ($("#status").val() == "true")
            return "Available"

        return "Not Available"

    }
    function setNode(node) {
        editNode = node.parentNode.parentNode.parentNode;
        mode = 1;


         $("#videoId").val(editNode.children[0].innerText);
        $("#source option:selected").text(editNode.children[1].innerText);
        $("#title").val(editNode.children[2].innerText);
        $("#thumbnail").val(editNode.children[3].innerText);
        $("#expiryDate").val(editNode.children[4].innerText);
                if (editNode.children[5].innerText == "Available") {
            $("#status").val("true");
            $("#status").prop("checked", true);
        }
        else {
            $("#status").val("false");
            $("#status").prop("checked", false);

        }
        $("#btnadd").val("Save");


    }
    $(document).ready(function () {


        //function will be called on button click having id btnsave

        $("#btnadd").click(function () {

            if (mode == 0) {
                $("#tableCategories tbody").append(`
                           <tr>
<td>${$("#videoId").val()}</td>
<td>${$("#source option:selected").text()}</td>
<td>${$("#title").val()}</td>
<td>${$("#thumbnail").val()}</td>
<td>${$("#expiryDate").val()}</td>
<td>${getStatus()}</td >

<td>
<div style="display:flex;"><button class="btn btn-info" style="color: white;border-top-right-radius: 0px;border-bottom-right-radius: 0px;" onclick="setNode(this)">Edit</button>

<button class="btn btn-danger" style="color: white;border-top-left-radius: 0px;border-bottom-left-radius: 0px;" onclick="deletenode(this)">Delete</button>
</div>
 </td>
</tr>
`);

            }
            else {

               
                editNode.children[0].innerText = $("#videoId").val();
                editNode.children[1].innerText = $("#source option:selected").text();
                editNode.children[2].innerText = $("#title").val();
                editNode.children[3].innerText = $("#thumbnail").val();
                editNode.children[4].innerText = $("#expiryDate").val();
                editNode.children[5].innerText = getStatus();

                mode = 0;
            }
            $("#videoId").val("");
            $("#title").val("");
            $("#thumbnail").val("");
            $("#status").val("true");
            $("#btnadd").val("Add");
            $("#status").prop("checked", true);
        })



        $("#btnSubmit").click(function () {
            var categories = [];
            $('table > tbody  >tr').each(function (index, tr) {

                categories.push({
                    videoId : tr.children[0].innerHTML,
                    source : tr.children[1].innerHTML,
                    title: tr.children[2].innerHTML,
                    thumbnail: tr.children[3].innerHTML,
                    expiryDate: tr.children[4].innerHTML,

                    status: (tr.children[5].innerHTML == "Available" ? true : false),
                })
            });

            if (categories.length > 0) {
                $.ajax({
                    type: "POST",
                    url: "/Api/postVideo",
                    headers: { 'Content-Type': 'application/json' },
                    data: JSON.stringify(categories),
                    contentType: "application/json",
                    success: function (response) {
                        toastr.success("Categories added successfully", "Success!", {
                            showMethod: "slideDown",
                            hideMethod: "slideUp",
                            timeOut: 2e3
                        });
                        $("#tableCategories tbody").html("")

                    },
                    failure: function (response) {
                        toastr.error("Opps Something wen't wrong", "Error!", {
                            showMethod: "slideDown",
                            hideMethod: "slideUp",
                            timeOut: 2e3
                        });

                        //alert(response.responseText);
                    },
                    error: function (response) {
                        toastr.error("Opps Something wen't wrong", "Error!", {
                            showMethod: "slideDown",
                            hideMethod: "slideUp",
                            timeOut: 2e3
                        });
                    }
                });
            }

        });

    });

</script> 